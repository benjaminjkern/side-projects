const allTeams = [
    {
        captain: "ben",
        team: [
            {
                position: "QB",
                projScore: 18.9,
            },
            {
                position: "RB",
                projScore: 12.9,
            },
            {
                position: "RB",
                projScore: 14.3,
            },
            {
                position: "WR",
                projScore: 22.1,
            },
            {
                position: "WR",
                projScore: 15.7,
            },
            {
                position: "TE",
                projScore: 9.2,
            },
            {
                position: "WR",
                projScore: 13.3,
            },
            {
                position: "DST",
                projScore: 8.3,
            },
            {
                position: "K",
                projScore: 8.7,
            },
            {
                position: "WR",
                projScore: 12.7,
            },
            {
                position: "RB",
                projScore: 11.4,
            },
            {
                position: "WR",
                projScore: 13.3,
            },
            {
                position: "WR",
                projScore: 11.1,
            },
            {
                position: "RB",
                projScore: 12.5,
            },
            {
                position: "QB",
                projScore: 17.9,
            },
            {
                position: "RB",
                projScore: 12.6,
            },
        ],
    },
    {
        captain: "diego",
        team: [
            {
                position: "QB",
                projScore: 18.5,
            },
            {
                position: "RB",
                projScore: 16.8,
            },
            {
                position: "RB",
                projScore: 9.0,
            },
            {
                position: "WR",
                projScore: 24.5,
            },
            {
                position: "WR",
                projScore: 19.4,
            },
            {
                position: "TE",
                projScore: 9.7,
            },
            {
                position: "RB",
                projScore: 12.4,
            },
            {
                position: "DST",
                projScore: 4.2,
            },
            {
                position: "K",
                projScore: 8.7,
            },
            {
                position: "RB",
                projScore: 14.1,
            },
            {
                position: "QB",
                projScore: 15.8,
            },
            {
                position: "WR",
                projScore: 12.8,
            },
            {
                position: "WR",
                projScore: 10.1,
            },
            {
                position: "WR",
                projScore: 8.1,
            },
            {
                position: "WR",
                projScore: 7.8,
            },
            {
                position: "TE",
                projScore: 9.3,
            },
        ],
    },
    {
        captain: "mac",
        team: [
            {
                position: "QB",
                projScore: 20.9,
            },
            {
                position: "RB",
                projScore: 17.5,
            },
            {
                position: "RB",
                projScore: 17.6,
            },
            {
                position: "WR",
                projScore: 17.7,
            },
            {
                position: "WR",
                projScore: 14.5,
            },
            {
                position: "TE",
                projScore: 9.1,
            },
            {
                position: "RB",
                projScore: 14.4,
            },
            {
                position: "DST",
                projScore: 3.3,
            },
            {
                position: "K",
                projScore: 8.3,
            },
            {
                position: "WR",
                projScore: 12.3,
            },
            {
                position: "TE",
                projScore: 8.4,
            },
            {
                position: "QB",
                projScore: 18.5,
            },
            {
                position: "RB",
                projScore: 8.8,
            },
            {
                position: "DST",
                projScore: 6.8,
            },
            {
                position: "RB",
                projScore: 10.1,
            },
            {
                position: "WR",
                projScore: 13.3,
            },
        ],
    },
    {
        captain: "andrew",
        team: [
            {
                position: "QB",
                projScore: 18.1,
            },
            {
                position: "RB",
                projScore: 18.6,
            },
            {
                position: "RB",
                projScore: 14.3,
            },
            {
                position: "WR",
                projScore: 14.4,
            },
            {
                position: "WR",
                projScore: 13.2,
            },
            {
                position: "TE",
                projScore: 11.2,
            },
            {
                position: "RB",
                projScore: 20.0,
            },
            {
                position: "DST",
                projScore: 7.0,
            },
            {
                position: "K",
                projScore: 7.8,
            },
            {
                position: "WR",
                projScore: 13.2,
            },
            {
                position: "RB",
                projScore: 14.1,
            },
            {
                position: "WR",
                projScore: 9.4,
            },
            {
                position: "WR",
                projScore: 14.2,
            },
            {
                position: "WR",
                projScore: 11.2,
            },
            {
                position: "WR",
                projScore: 11.1,
            },
            {
                position: "WR",
                projScore: 12.2,
            },
            {
                position: "RB",
                projScore: 0.0,
            },
        ],
    },
    {
        captain: "josh",
        team: [
            {
                position: "QB",
                projScore: 21.7,
            },
            {
                position: "RB",
                projScore: 12.5,
            },
            {
                position: "RB",
                projScore: 14.9,
            },
            {
                position: "WR",
                projScore: 19.7,
            },
            {
                position: "WR",
                projScore: 13.9,
            },
            {
                position: "TE",
                projScore: 14.1,
            },
            {
                position: "TE",
                projScore: 10.7,
            },
            {
                position: "DST",
                projScore: 7.3,
            },
            {
                position: "K",
                projScore: 7.4,
            },
            {
                position: "WR",
                projScore: 0.0,
            },
            {
                position: "RB",
                projScore: 12.7,
            },
            {
                position: "TE",
                projScore: 8.4,
            },
            {
                position: "K",
                projScore: 7.6,
            },
            {
                position: "DST",
                projScore: 4.8,
            },
            {
                position: "QB",
                projScore: 15.0,
            },
            {
                position: "RB",
                projScore: 5.7,
            },
        ],
    },
    {
        captain: "soph",
        team: [
            {
                position: "QB",
                projScore: 22.0,
            },
            {
                position: "RB",
                projScore: 14.7,
            },
            {
                position: "RB",
                projScore: 14.3,
            },
            {
                position: "WR",
                projScore: 13.9,
            },
            {
                position: "WR",
                projScore: 15.8,
            },
            {
                position: "TE",
                projScore: 17.0,
            },
            {
                position: "RB",
                projScore: 14.1,
            },
            {
                position: "DST",
                projScore: 7.8,
            },
            {
                position: "K",
                projScore: 8.1,
            },
            {
                position: "RB",
                projScore: 2.1,
            },
            {
                position: "WR",
                projScore: 13.4,
            },
            {
                position: "WR",
                projScore: 10.4,
            },
            {
                position: "RB",
                projScore: 8.0,
            },
            {
                position: "QB",
                projScore: 19.1,
            },
            {
                position: "DST",
                projScore: 2.8,
            },
            {
                position: "TE",
                projScore: 7.8,
            },
        ],
    },
];

const maxInPerTeam = {
    QB: 1,
    RB: 2,
    WR: 2,
    TE: 1,
    FLX: 1,
    DST: 1,
    K: 1,
};

// Assume flex is filled with best of remaining
const calcProjScore = (team) => {
    let remainingTeam = [...team];
    const chosenTeam = []; // not really used right now but can be
    const projectedScore = Object.keys(maxInPerTeam).reduce((sum, position) => {
        const selectedPlayers = remainingTeam
            .map((player, i) => [player, i])
            .filter(([player]) => {
                // Assume FLX means RB or WB or TE
                if (position === "FLX")
                    return ["RB", "WR", "TE"].includes(player.position);
                return player.position === position;
            })
            .sort(([a], [b]) => b.projScore - a.projScore)
            .slice(0, maxInPerTeam[position]);

        chosenTeam.push(...selectedPlayers.map(([player]) => player));
        remainingTeam = remainingTeam.filter(
            (player, i) =>
                !selectedPlayers.some(([player, index]) => index === i)
        );
        return (
            sum +
            selectedPlayers.reduce((p, [player]) => p + player.projScore, 0)
        );
    }, 0);
    return [projectedScore, chosenTeam];
};

let hitLimit = false;

const findGoodTrades = (captainName, allTeamsTemp, depth = 1) => {
    if (depth === 0) {
        hitLimit = true;
        return [];
    }
    const goodTrades = [];

    const team1Index = allTeamsTemp.findIndex(
        (team) => team.captain === captainName
    );
    const team1 = allTeamsTemp[team1Index].team;
    for (const [
        team2Index,
        { captain, team: team2 },
    ] of allTeamsTemp.entries()) {
        if (captain === captainName) continue;

        // Naive
        const [team1Score, bestTeam1] = calcProjScore(team1);
        const [team2Score, bestTeam2] = calcProjScore(team2);
        for (let i1 = 0; i1 < team1.length; i1++) {
            for (let i2 = 0; i2 < team2.length; i2++) {
                const tradeTeam1 = [
                    ...team1.slice(0, i1),
                    team2[i2],
                    ...team1.slice(i1 + 1),
                ];
                const tradeTeam2 = [
                    ...team2.slice(0, i2),
                    team1[i1],
                    ...team2.slice(i2 + 1),
                ];
                const [newTeam1Score, newBestTeam1] = calcProjScore(tradeTeam1);
                const [newTeam2Score, newBestTeam2] = calcProjScore(tradeTeam2);
                if (
                    newTeam1Score > team1Score &&
                    newTeam2Score > team2Score &&
                    !(
                        newTeam1Score === team1Score &&
                        newTeam2Score === team2Score
                    )
                ) {
                    const newAllTeams = [...allTeamsTemp];
                    newAllTeams[team1Index] = {
                        captain: captainName,
                        team: tradeTeam1,
                    };
                    newAllTeams[team2Index] = {
                        captain: captain,
                        team: tradeTeam2,
                    };

                    const subtrades = findGoodTrades(
                        captainName,
                        newAllTeams,
                        depth - 1
                    );

                    const result = {
                        [captainName]: newTeam1Score - team1Score,
                        [captain]: newTeam2Score - team2Score,
                    };

                    goodTrades.push({
                        opTeam: captain,
                        trade: [i1, i2],
                        result,
                        subtrades,
                    });
                }
            }
        }
    }
    return goodTrades;
};

const roundN = (x, N = 1) => {
    return Math.round(x * 10 ** N) / 10 ** N;
};

const addToResults = (results, newResults) => {
    for (const captainName of Object.keys(newResults)) {
        results[captainName] =
            (results[captainName] || 0) + newResults[captainName];
    }
};

const getBestTradeResults = (goodTrades, team1Captain) => {
    const getBestResultsForEveryoneElse = (bestResultSubtrade) =>
        Object.keys(bestResultSubtrade).reduce(
            (p, c) => p + (c === team1Captain ? 0 : bestResultSubtrade[c]),
            0
        );
    let bestTrades = [];
    let bestResult = { [team1Captain]: 0 };
    for (const { opTeam, trade, subtrades, result } of goodTrades) {
        const [bestTradesSubtrade, bestResultSubtrade] = getBestTradeResults(
            subtrades,
            team1Captain
        );
        bestTradesSubtrade.splice(0, 0, { opTeam, trade });
        addToResults(bestResultSubtrade, result);

        const resultsForEveryoneElseSubtrade =
            getBestResultsForEveryoneElse(bestResultSubtrade);
        const resultsForEveryoneElse =
            getBestResultsForEveryoneElse(bestResult);

        if (
            bestResultSubtrade[team1Captain] > bestResult[team1Captain] ||
            (bestResultSubtrade[team1Captain] === bestResult[team1Captain] &&
                (resultsForEveryoneElseSubtrade < resultsForEveryoneElse ||
                    (resultsForEveryoneElseSubtrade ===
                        resultsForEveryoneElse &&
                        bestTradesSubtrade.length < bestTrades.length)))
        ) {
            bestTrades = bestTradesSubtrade;
            bestResult = bestResultSubtrade;
        }
    }
    return [bestTrades, bestResult];
};

const goodTrades = findGoodTrades("ben", allTeams, 7);

// console.log(require("util").inspect(goodTrades, null, null, true));

const [bestTrades, results] = getBestTradeResults(goodTrades, "ben");

bestTrades.map(({ opTeam, trade: [team1Index, team2Index] }) => {
    const player1 = allTeams.find(({ captain }) => captain === "ben").team[
        team1Index
    ];
    const player2 = allTeams.find(({ captain }) => captain === opTeam).team[
        team2Index
    ];
    console.log(
        "Trade your player",
        team1Index,
        player1,
        "with <",
        opTeam,
        ">'s player",
        team2Index,
        player2
    );
});
console.log("Result:", results);
if (!hitLimit) console.log("Exhausted all options.");
else console.log("Did not finish recursing.");
